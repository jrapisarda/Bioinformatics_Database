{% extends "base.html" %}

{% block title %}Database Connection - Gene Pair ML Analysis{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-database me-2"></i>
                        Database Connection
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        Connect to your database to fetch gene pair data for analysis. 
                        Supported databases: SQL Server, MySQL, PostgreSQL.
                    </p>

                    <form id="databaseForm">
                        <!-- Database Type -->
                        <div class="mb-3">
                            <label for="db_type" class="form-label">Database Type</label>
                            <select class="form-select" id="db_type" name="db_type" required>
                                <option value="">Select Database Type</option>
                                <option value="sqlserver">SQL Server</option>
                                <option value="mysql">MySQL</option>
                                <option value="postgresql">PostgreSQL</option>
                            </select>
                        </div>

                        <!-- Connection Details -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="host" class="form-label">Host</label>
                                    <input type="text" class="form-control" id="host" name="host" 
                                           placeholder="localhost" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="port" class="form-label">Port</label>
                                    <input type="number" class="form-control" id="port" name="port" 
                                           placeholder="1433" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="database" class="form-label">Database Name</label>
                                    <input type="text" class="form-control" id="database" name="database" 
                                           placeholder="gene_analysis" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="table" class="form-label">Table Name</label>
                                    <input type="text" class="form-control" id="table" name="table" 
                                           placeholder="gene_pairs" required>
                                </div>
                            </div>
                        </div>

                        <!-- Authentication -->
                        <div class="mb-3">
                            <label class="form-label">Authentication</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="username" name="username" 
                                           placeholder="Username" required>
                                </div>
                                <div class="col-md-6">
                                    <input type="password" class="form-control" id="password" name="password" 
                                           placeholder="Password" required>
                                </div>
                            </div>
                        </div>

                        <!-- Filters -->
                        <div class="mb-4">
                            <h6 class="fw-bold">Data Filters (Optional)</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="min_p_value" class="form-label">Min P-value</label>
                                        <input type="number" class="form-control" id="min_p_value" name="min_p_value" 
                                               placeholder="0.001" step="0.001">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="min_effect_size" class="form-label">Min Effect Size</label>
                                        <input type="number" class="form-control" id="min_effect_size" name="min_effect_size" 
                                               placeholder="0.5" step="0.1">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary" onclick="testConnection()">
                                <i class="fas fa-plug me-1"></i>Test Connection
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-download me-1"></i>Fetch Data
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Status -->
    <div class="row mt-4">
        <div class="col-lg-8 mx-auto">
            <div id="connectionStatus" class="card" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Connection Status
                    </h5>
                </div>
                <div class="card-body" id="statusContent">
                    <!-- Status content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Sample Queries -->
    <div class="row mt-4">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-code me-2"></i>
                        Sample Queries
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Here are example queries for creating the required table structure:
                    </p>
                    
                    <div class="mb-3">
                        <h6>SQL Server / MySQL:</h6>
                        <pre class="bg-light p-2 rounded"><code>CREATE TABLE gene_pairs (
    id INT PRIMARY KEY,
    gene_a VARCHAR(50),
    gene_b VARCHAR(50),
    p_value_ss FLOAT,
    p_value_soth FLOAT,
    effect_size_ss FLOAT,
    effect_size_soth FLOAT,
    sample_size INT,
    study_id VARCHAR(50),
    condition VARCHAR(100)
);</code></pre>
                    </div>
                    
                    <div class="mb-3">
                        <h6>PostgreSQL:</h6>
                        <pre class="bg-light p-2 rounded"><code>CREATE TABLE gene_pairs (
    id SERIAL PRIMARY KEY,
    gene_a VARCHAR(50),
    gene_b VARCHAR(50),
    p_value_ss DOUBLE PRECISION,
    p_value_soth DOUBLE PRECISION,
    effect_size_ss DOUBLE PRECISION,
    effect_size_soth DOUBLE PRECISION,
    sample_size INTEGER,
    study_id VARCHAR(50),
    condition VARCHAR(100)
);</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function testConnection() {
    const form = document.getElementById('databaseForm');
    const formData = new FormData(form);
    const config = Object.fromEntries(formData);
    
    // Show loading state
    const testBtn = document.querySelector('button[onclick="testConnection()"]');
    testBtn.disabled = true;
    testBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Testing...';
    
    // Simulate connection test (replace with real API call)
    setTimeout(() => {
        showConnectionStatus('success', 'Connection successful!', {
            database: config.database,
            host: config.host,
            port: config.port,
            table: config.table
        });
        
        // Reset button
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="fas fa-plug me-1"></i>Test Connection';
    }, 2000);
    
    // Real implementation would be:
    /*
    fetch('/api/database/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.connected) {
            showConnectionStatus('success', 'Connection successful!', data);
        } else {
            showConnectionStatus('error', 'Connection failed: ' + data.error, data);
        }
    })
    .catch(error => {
        showConnectionStatus('error', 'Connection error: ' + error.message);
    })
    .finally(() => {
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="fas fa-plug me-1"></i>Test Connection';
    });
    */
}

document.getElementById('databaseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const config = Object.fromEntries(formData);
    
    // Show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Fetching...';
    
    // Simulate data fetch (replace with real API call)
    setTimeout(() => {
        alert('Data fetch simulation complete. In real implementation, this would fetch data from the database.');
        
        // Reset button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-download me-1"></i>Fetch Data';
    }, 3000);
    
    // Real implementation would be:
    /*
    fetch('/api/database/data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            config: config,
            filters: {
                min_p_value: config.min_p_value,
                min_effect_size: config.min_effect_size
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.session_id) {
            window.location.href = `/analyze/${data.session_id}`;
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error fetching data: ' + error.message);
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-download me-1"></i>Fetch Data';
    });
    */
});

function showConnectionStatus(type, message, data = null) {
    const statusCard = document.getElementById('connectionStatus');
    const statusContent = document.getElementById('statusContent');
    
    let icon, alertClass;
    if (type === 'success') {
        icon = '<i class="fas fa-check-circle text-success me-2"></i>';
        alertClass = 'alert-success';
    } else {
        icon = '<i class="fas fa-times-circle text-danger me-2"></i>';
        alertClass = 'alert-danger';
    }
    
    let content = `
        <div class="alert ${alertClass} mb-3">
            ${icon} ${message}
        </div>
    `;
    
    if (data) {
        content += `
            <div class="row">
                <div class="col-md-6">
                    <h6>Connection Details:</h6>
                    <ul class="list-unstyled">
                        <li><strong>Host:</strong> ${data.host}</li>
                        <li><strong>Port:</strong> ${data.port}</li>
                        <li><strong>Database:</strong> ${data.database}</li>
                        <li><strong>Table:</strong> ${data.table}</li>
                    </ul>
                </div>
            </div>
        `;
    }
    
    statusContent.innerHTML = content;
    statusCard.style.display = 'block';
    
    // Scroll to status
    statusCard.scrollIntoView({ behavior: 'smooth' });
}

// Set default port based on database type
document.getElementById('db_type').addEventListener('change', function() {
    const portInput = document.getElementById('port');
    const dbType = this.value;
    
    switch(dbType) {
        case 'sqlserver':
            portInput.value = '1433';
            break;
        case 'mysql':
            portInput.value = '3306';
            break;
        case 'postgresql':
            portInput.value = '5432';
            break;
        default:
            portInput.value = '';
    }
});
</script>
{% endblock %}