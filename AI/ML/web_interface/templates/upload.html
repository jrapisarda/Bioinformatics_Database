{% extends "base.html" %}

{% block title %}Upload Data - Gene Pair ML Analysis{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-upload me-2"></i>
                        Upload Meta-Analysis Data
                    </h4>
                </div>
                <div class="card-body p-4">
                    <!-- Upload Form -->
                    <form method="POST" enctype="multipart/form-data" id="uploadForm">
                        <div class="mb-4">
                            <label for="file" class="form-label fw-bold">
                                <i class="fas fa-file me-2"></i>
                                Select File to Upload
                            </label>
                            <input type="file" class="form-control form-control-lg" id="file" name="file" 
                                   accept=".xlsx,.xls,.csv,.json" required>
                            <div class="form-text">
                                Supported formats: Excel (.xlsx, .xls), CSV, JSON. Maximum file size: 16MB
                            </div>
                        </div>
                        
                        <!-- File Info Display -->
                        <div id="fileInfo" class="mb-4" style="display: none;">
                            <div class="card border-light">
                                <div class="card-body">
                                    <h6 class="card-title">File Information</h6>
                                    <div id="fileDetails"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upload Button -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                                <i class="fas fa-cloud-upload-alt me-2"></i>
                                Upload and Validate Data
                            </button>
                        </div>
                    </form>
                    
                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="mt-4" style="display: none;">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Uploading and validating...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" id="progressBar" 
                                 style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Format Information -->
    <div class="row mt-4">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Data Format Requirements
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Required Columns:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Gene_A</li>
                                <li><i class="fas fa-check text-success me-2"></i>Gene_B</li>
                                <li><i class="fas fa-check text-success me-2"></i>p_value_ss</li>
                                <li><i class="fas fa-check text-success me-2"></i>p_value_soth</li>
                                <li><i class="fas fa-check text-success me-2"></i>effect_size_ss</li>
                                <li><i class="fas fa-check text-success me-2"></i>effect_size_soth</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Optional Columns:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-plus text-info me-2"></i>sample_size</li>
                                <li><i class="fas fa-plus text-info me-2"></i>study_id</li>
                                <li><i class="fas fa-plus text-info me-2"></i>condition</li>
                                <li><i class="fas fa-plus text-info me-2"></i>additional_metadata</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Tip:</strong> The system will automatically validate your data format and provide feedback on any issues.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sample Data Download -->
    <div class="row mt-4">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-download me-2"></i>
                        Sample Data
                    </h5>
                </div>
                <div class="card-body text-center">
                    <p class="mb-3">Download sample data to test the system:</p>
                    <button class="btn btn-outline-primary" onclick="downloadSampleData()">
                        <i class="fas fa-file-excel me-2"></i>
                        Download Sample Excel File
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// File selection handler
document.getElementById('file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const fileInfo = document.getElementById('fileInfo');
    const fileDetails = document.getElementById('fileDetails');
    
    if (file) {
        // Show file info
        const fileSize = (file.size / (1024 * 1024)).toFixed(2); // Convert to MB
        const fileType = file.type || 'Unknown';
        const lastModified = new Date(file.lastModified).toLocaleDateString();
        
        fileDetails.innerHTML = `
            <div class="row">
                <div class="col-sm-6">
                    <strong>Name:</strong> ${file.name}
                </div>
                <div class="col-sm-6">
                    <strong>Size:</strong> ${fileSize} MB
                </div>
                <div class="col-sm-6">
                    <strong>Type:</strong> ${fileType}
                </div>
                <div class="col-sm-6">
                    <strong>Modified:</strong> ${lastModified}
                </div>
            </div>
        `;
        
        fileInfo.style.display = 'block';
        
        // Validate file extension
        const allowedExtensions = ['.xlsx', '.xls', '.csv', '.json'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedExtensions.includes(fileExtension)) {
            alert('Please select a valid file format: Excel (.xlsx, .xls), CSV, or JSON');
            e.target.value = '';
            fileInfo.style.display = 'none';
        }
    } else {
        fileInfo.style.display = 'none';
    }
});

// Form submission handler
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const file = document.getElementById('file').files[0];
    
    if (!file) {
        e.preventDefault();
        alert('Please select a file to upload.');
        return;
    }
    
    // Show progress bar
    document.getElementById('uploadProgress').style.display = 'block';
    
    // Simulate progress (in real implementation, this would track actual upload progress)
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
        }
        
        progressBar.style.width = progress + '%';
        progressPercent.textContent = Math.round(progress) + '%';
    }, 200);
    
    // Disable upload button
    document.getElementById('uploadBtn').disabled = true;
    document.getElementById('uploadBtn').innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
});

// Sample data download
function downloadSampleData() {
    // Create sample data for download
    const sampleData = [
        ['Gene_A', 'Gene_B', 'p_value_ss', 'p_value_soth', 'effect_size_ss', 'effect_size_soth'],
        ['MS4A4A', 'CD86', '0.001', '0.0001', '0.85', '0.92'],
        ['DHRS9', 'SULF2', '0.001', '2.2e-08', '-0.66', '-1.03'],
        ['MBTD1', 'CD86', '0.001', '2.5e-07', '0.65', '0.62'],
        ['CXCR5', 'ZDHHC19', '0.002', '1.0e-05', '-0.62', '-0.61'],
        ['NPL', 'S100P', '0.001', '2.2e-06', '-0.64', '-0.57'],
        ['SLCO4A1', 'SLC39A8', '0.004', '1.7e-06', '0.57', '0.68']
    ];
    
    // Convert to CSV format
    const csvContent = sampleData.map(row => row.join(',')).join('\n');
    
    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sample_gene_pair_data.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Drag and drop functionality (bonus feature)
const dropZone = document.createElement('div');
dropZone.className = 'border-2 border-dashed border-primary rounded p-4 text-center mt-3';
dropZone.style.display = 'none';
dropZone.innerHTML = `
    <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
    <p class="mb-0">Drop your file here to upload</p>
`;

// Add drag and drop event listeners
document.addEventListener('dragover', function(e) {
    e.preventDefault();
    dropZone.style.display = 'block';
});

document.addEventListener('dragleave', function(e) {
    if (e.target === document.body) {
        dropZone.style.display = 'none';
    }
});

document.addEventListener('drop', function(e) {
    e.preventDefault();
    dropZone.style.display = 'none';
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        document.getElementById('file').files = files;
        // Trigger change event
        document.getElementById('file').dispatchEvent(new Event('change'));
    }
});

// Add drop zone to the form
document.getElementById('uploadForm').appendChild(dropZone);
</script>
{% endblock %}