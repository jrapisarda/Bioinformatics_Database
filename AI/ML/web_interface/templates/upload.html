<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload Meta-Analysis Results</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous"
    >
    <style>
        body {
            background-color: #f7f9fb;
        }
        .page-header {
            background: linear-gradient(135deg, #2E8B8B, #1b4f72);
            color: #fff;
            padding: 3rem 1rem;
            border-radius: 0 0 1.5rem 1.5rem;
            margin-bottom: 2rem;
        }
        .required-columns li {
            margin-bottom: 0.25rem;
        }
        code {
            font-size: 0.95rem;
        }
    </style>
</head>
<body>
<div class="page-header text-center">
    <h1 class="display-6 mb-2">Upload Meta-Analysis Results</h1>
    <p class="lead mb-0">Provide a CSV, Excel, or JSON file that follows the Bioinformatics Meta-Analysis schema.</p>
</div>
<div class="container pb-5">
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="h4 mb-3">Upload File</h2>
                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label for="file" class="form-label">Select data file</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".csv,.xlsx,.xls,.json" required>
                            <div class="form-text">Accepted formats: CSV, Excel (.xlsx, .xls), or JSON</div>
                            <div class="invalid-feedback">Please choose a data file that matches the required schema.</div>
                        </div>
                        <button type="submit" class="btn btn-primary">Upload and Validate</button>
                        <a id="download-sample" class="btn btn-outline-secondary ms-2" href="#">Download Sample CSV</a>
                    </form>
                    <hr class="my-4">
                    <h3 class="h5">Legacy column headers?</h3>
                    <p class="mb-0">
                        Common legacy headers such as <code>Gene_A</code>, <code>Gene_B</code>, or <code>PairID</code> are
                        automatically normalised to the current schema before validation. Ensure every required field is present even if aliases are used.
                    </p>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h2 class="h4 mb-3">Required Columns</h2>
                    <p>Provide all of the following columns in your upload:</p>
                    <ul class="required-columns">
                        <li><code>pair_id</code></li>
                        <li><code>n_studies_ss</code></li>
                        <li><code>n_studies_soth</code></li>
                        <li><code>dz_ss_mean</code></li>
                        <li><code>dz_ss_se</code></li>
                        <li><code>dz_ss_ci_low</code></li>
                        <li><code>dz_ss_ci_high</code></li>
                        <li><code>dz_ss_Q</code></li>
                        <li><code>dz_ss_I2</code></li>
                        <li><code>dz_ss_z</code></li>
                        <li><code>p_ss</code></li>
                        <li><code>dz_soth_mean</code></li>
                        <li><code>dz_soth_se</code></li>
                        <li><code>dz_soth_ci_low</code></li>
                        <li><code>dz_soth_ci_high</code></li>
                        <li><code>dz_soth_Q</code></li>
                        <li><code>dz_soth_I2</code></li>
                        <li><code>dz_soth_z</code></li>
                        <li><code>p_soth</code></li>
                        <li><code>kappa_ss</code></li>
                        <li><code>kappa_soth</code></li>
                        <li><code>abs_dz_ss</code></li>
                        <li><code>abs_dz_soth</code></li>
                        <li><code>q_ss</code></li>
                        <li><code>q_soth</code></li>
                        <li><code>rank_score</code></li>
                        <li><code>GeneAName</code></li>
                        <li><code>GeneBName</code></li>
                        <li><code>GeneAKey</code></li>
                        <li><code>GeneBKey</code></li>
                    </ul>
                    <h3 class="h5 mt-4">Optional Columns</h3>
                    <p class="mb-1">The processor will also accept the following fields when available:</p>
                    <ul class="mb-0">
                        <li><code>study_key</code></li>
                        <li><code>illness_label</code></li>
                        <li><code>rho_spearman</code></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
(() => {
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    }, false);
})();

(function registerSampleDownload() {
    const requiredColumns = [
        'pair_id', 'n_studies_ss', 'n_studies_soth',
        'dz_ss_mean', 'dz_ss_se', 'dz_ss_ci_low', 'dz_ss_ci_high',
        'dz_ss_Q', 'dz_ss_I2', 'dz_ss_z', 'p_ss',
        'dz_soth_mean', 'dz_soth_se', 'dz_soth_ci_low', 'dz_soth_ci_high',
        'dz_soth_Q', 'dz_soth_I2', 'dz_soth_z', 'p_soth',
        'kappa_ss', 'kappa_soth', 'abs_dz_ss', 'abs_dz_soth',
        'q_ss', 'q_soth', 'rank_score',
        'GeneAName', 'GeneBName', 'GeneAKey', 'GeneBKey'
    ];

    const sampleRows = [
        {
            pair_id: 'PAIR_0001',
            n_studies_ss: 4,
            n_studies_soth: 6,
            dz_ss_mean: -0.42,
            dz_ss_se: 0.12,
            dz_ss_ci_low: -0.65,
            dz_ss_ci_high: -0.19,
            dz_ss_Q: 3.1,
            dz_ss_I2: 24.5,
            dz_ss_z: -3.50,
            p_ss: 0.0004,
            dz_soth_mean: -0.88,
            dz_soth_se: 0.22,
            dz_soth_ci_low: -1.31,
            dz_soth_ci_high: -0.45,
            dz_soth_Q: 5.2,
            dz_soth_I2: 35.1,
            dz_soth_z: -4.00,
            p_soth: 0.0001,
            kappa_ss: 0.83,
            kappa_soth: 0.79,
            abs_dz_ss: 0.42,
            abs_dz_soth: 0.88,
            q_ss: 0.0008,
            q_soth: 0.0003,
            rank_score: 1.42,
            GeneAName: 'MS4A4A',
            GeneBName: 'CD86',
            GeneAKey: '101',
            GeneBKey: '205'
        },
        {
            pair_id: 'PAIR_0002',
            n_studies_ss: 3,
            n_studies_soth: 5,
            dz_ss_mean: -0.55,
            dz_ss_se: 0.15,
            dz_ss_ci_low: -0.85,
            dz_ss_ci_high: -0.25,
            dz_ss_Q: 2.6,
            dz_ss_I2: 18.2,
            dz_ss_z: -3.67,
            p_ss: 0.0012,
            dz_soth_mean: -1.12,
            dz_soth_se: 0.28,
            dz_soth_ci_low: -1.66,
            dz_soth_ci_high: -0.58,
            dz_soth_Q: 4.8,
            dz_soth_I2: 41.0,
            dz_soth_z: -4.00,
            p_soth: 0.0005,
            kappa_ss: 0.88,
            kappa_soth: 0.81,
            abs_dz_ss: 0.55,
            abs_dz_soth: 1.12,
            q_ss: 0.0024,
            q_soth: 0.0010,
            rank_score: 1.35,
            GeneAName: 'RGCC',
            GeneBName: 'DHRS9',
            GeneAKey: '334',
            GeneBKey: '412'
        }
    ];

    function formatValue(value) {
        if (typeof value === 'number') {
            return value.toString();
        }
        return `"${String(value).replace(/"/g, '""')}"`;
    }

    function buildCsv() {
        const rows = [requiredColumns.join(',')];
        for (const row of sampleRows) {
            const values = requiredColumns.map(column => formatValue(row[column] ?? ''));
            rows.push(values.join(','));
        }
        return rows.join('\n');
    }

    const downloadLink = document.getElementById('download-sample');
    downloadLink.addEventListener('click', event => {
        event.preventDefault();
        const csvContent = buildCsv();
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const tempLink = document.createElement('a');
        tempLink.href = url;
        tempLink.download = 'meta_analysis_sample.csv';
        document.body.appendChild(tempLink);
        tempLink.click();
        document.body.removeChild(tempLink);
        URL.revokeObjectURL(url);
    });
})();
</script>
</body>
</html>
